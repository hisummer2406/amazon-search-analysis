# postgresql.conf - 针对阿里云4核8GB服务器优化

# 内存配置 - 更激进的内存使用
shared_buffers = 2GB                    # 增加到2GB，充分利用内存
effective_cache_size = 6GB              # 增加到6GB
work_mem = 64MB                         # 降低到64MB，避免内存不足
maintenance_work_mem = 256MB            # 降低维护内存
temp_buffers = 16MB                     # 降低临时缓冲区

# 并发配置 - 针对4核优化
max_connections = 100                   # 增加连接数
max_worker_processes = 4                # 等于CPU核心数
max_parallel_workers_per_gather = 2     # 适度并行
max_parallel_workers = 4                # 增加并行工作进程
max_parallel_maintenance_workers = 2    # 并行维护

# I/O 配置 - SSD优化
effective_io_concurrency = 200          # 增加IO并发
random_page_cost = 1.1                  # SSD优化
seq_page_cost = 1.0                     # 顺序读取成本
checkpoint_completion_target = 0.9
wal_buffers = 32MB                      # 增加WAL缓冲
checkpoint_timeout = 5min               # 减少检查点间隔

# 查询优化器配置
default_statistics_target = 100         # 提高统计信息精度
constraint_exclusion = partition        # 分区优化
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on

# 大文件处理优化
wal_level = replica                     # 保持适度WAL
max_wal_size = 2GB                      # 增加WAL大小
min_wal_size = 1GB
synchronous_commit = off                # 异步提交提高性能
fsync = on                             # 保持数据安全
full_page_writes = on                   # 保持数据完整性
wal_compression = on                    # 启用WAL压缩

# 超时配置
statement_timeout = 60000               # 降低到1分钟
idle_in_transaction_session_timeout = 300000  # 5分钟事务超时
lock_timeout = 30000                    # 30秒锁超时
tcp_keepalives_idle = 300              # 5分钟TCP保活
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# 连接配置
listen_addresses = '*'
timezone = 'Asia/Shanghai'

# 日志配置（用于性能调试）
log_min_duration_statement = 1000      # 记录超过1秒的查询
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 10MB

# 缓存配置
shared_preload_libraries = 'pg_stat_statements'  # 查询统计
track_activity_query_size = 2048
track_functions = all